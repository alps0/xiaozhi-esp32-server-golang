# 声音复刻功能说明

本文档介绍项目中的 **声音复刻（Voice Clone）** 功能，包括普通用户的创建/试听/重试流程，以及管理员的复刻额度管理。

相关页面与文档：

- 管理员 `TTS配置管理`（为用户提供可用 TTS 配置）
- 管理员 `用户管理 -> 复刻额度`
- 普通用户 `声音复刻`
- [管理后台使用指南](./manager_console_guide.md)

---

## 1. 功能概览

声音复刻功能允许用户上传音频（或浏览器录音），在支持的 TTS 提供商上创建“复刻音色”，随后在智能体/角色中选择该音色进行播报。

当前前后端已支持的复刻提供商：

- `minimax`
- `cosyvoice`
- `aliyun_qwen`（千问）

不在上述列表的 TTS 提供商，即使可用于普通 TTS 合成，也不能用于声音复刻。

---

## 2. 角色与权限

### 2.1 普通用户

可以：

- 创建复刻音色
- 查看复刻任务状态
- 试听原始音频与复刻音频
- 编辑复刻名称
- 对失败任务发起重试

### 2.2 管理员

可以：

- 配置并启用可复刻的 TTS 提供商
- 为每个用户按 `TTS配置` 设置复刻额度（可选）

---

## 3. 前置条件

在使用前请确认：

1. 管理员已创建并启用至少一个 TTS 配置（provider 为 `minimax` / `cosyvoice` / `aliyun_qwen`）
2. 普通用户可在“声音复刻”页面看到该 TTS 配置
3. （可选）管理员已为该用户分配复刻额度

说明：

- 若未配置额度，默认兼容历史行为，通常视为“不限制”

---

## 4. 普通用户使用流程

入口：

- `普通用户 -> 声音复刻`

## 4.1 创建复刻音色

点击 `创建复刻音色`，填写：

- `复刻名称`（可选，不填时会使用文件名）
- `TTS配置`（必须选择支持复刻的配置）
- `音频来源`（上传音频 / 浏览器录音）
- `音频对应文字`（是否必填由 provider 能力决定）
- `文字语言`（如 `zh-CN` / `en-US`）

提交后可能出现两种结果：

- 立即成功（少见）
- 返回“已提交复刻任务，正在后台处理”（常见，异步）

## 4.2 查看任务状态

列表中会展示：

- 提供商
- 关联 TTS 配置
- 复刻音色 ID
- 任务状态
- 失败原因（若有）
- 创建时间

常见状态可理解为：

- 排队中 / 处理中
- 已完成（可试听）
- 失败（可查看失败原因并重试）

## 4.3 试听与管理

每条复刻记录支持以下操作：

- `原音频`：播放用户提交的音频样本
- `试听复刻`：播放 provider 返回的复刻音色（仅成功状态显示）
- `编辑`：修改复刻名称
- `重新复刻`：对失败任务重新提交（仅失败状态显示）

---

## 5. Provider 差异与注意事项

## 5.1 Minimax

前端与后端会对音频做约束校验，常见规则：

- 音频格式通常要求 `WAV`
- 音频时长建议/要求不少于 `10 秒`

页面会在上传/录音区域给出提示，并在时长不足时阻止提交。

## 5.2 CosyVoice

特点：

- 支持复刻
- 常见场景下要求填写“音频对应文字”（由 provider 能力接口返回）

实际是否必填，以页面当前 provider 能力提示为准。

## 5.3 千问（`aliyun_qwen`）

特点：

- 支持复刻
- 支持更多音频格式（如 `WAV/MP3/M4A`，以页面提示为准）
- 选择该类复刻音色后，运行时会自动切换到对应的复刻模型（前端会给出提示）

---

## 6. 复刻额度管理（管理员）

入口：

- `管理员 -> 用户管理 -> 复刻额度`

管理员可按 `TTS配置ID` 为某个普通用户配置复刻额度：

- `-1`：不限次数
- `0`：禁止创建
- `正整数`：最大可复刻次数

额度统计通常按“提交复刻任务”计数（失败重试也应纳入计数策略，请结合当前业务规则使用）。

---

## 7. 接口说明（用户侧）

### 7.1 能力探测

- `GET /user/voice-clone/capabilities?provider=<provider>`

用途：

- 获取 provider 是否启用
- 是否要求填写 transcript
- 文本长度范围
- 支持语言列表

### 7.2 复刻记录与任务操作

- `POST /user/voice-clones`（创建复刻，`multipart/form-data`）
- `GET /user/voice-clones`（列表）
- `PUT /user/voice-clones/:id`（修改名称）
- `POST /user/voice-clones/:id/retry`（失败重试）
- `GET /user/voice-clones/:id/preview`（试听复刻音色）

### 7.3 原始音频管理

- `GET /user/voice-clones/:id/audios`
- `GET /user/voice-clones/audios/:audio_id/file`

---

## 8. 接口说明（管理员额度）

- `GET /admin/users/:id/voice-clone-quotas`
- `PUT /admin/users/:id/voice-clone-quotas`

---

## 9. 常见问题与排查

### 9.1 页面看不到可选 TTS 配置

排查：

1. 管理员是否启用了 TTS 配置
2. TTS provider 是否属于支持复刻的列表（`minimax/cosyvoice/aliyun_qwen`）
3. 当前用户是否有权限访问该配置

### 9.2 提交时报“该提供商要求填写音频对应文字”

说明该 provider 能力要求 transcript 必填，请补充音频对应文字后提交。

### 9.3 提交时报额度不足

管理员需要在 `用户管理 -> 复刻额度` 中为该用户对应的 `TTS配置ID` 提高额度或设置为 `-1`。

### 9.4 复刻成功但无法试听

排查：

1. 任务状态是否已完成
2. provider 预览接口是否正常
3. 浏览器是否拦截了音频自动播放（手动点击播放按钮重试）

---

## 10. 使用建议

- 为每个场景准备独立的 TTS 配置（便于额度控制与计费归因）
- 提交音频尽量使用干净人声、低噪声环境
- transcript 尽量与音频内容一致，有助于复刻效果与稳定性

